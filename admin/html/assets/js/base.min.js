angular.module("miUtil",[]).run(["$rootScope","$document","$timeout",function(e,t,n){window.FastClick&&FastClick.attach(document.body),window.viewportUnitsBuggyfill&&viewportUnitsBuggyfill.init();var r=e.$menu={active:!1,open:function(e){r.active=!0,e&&e.stopPropagation()},close:function(e){r.active=!1,e&&e.stopPropagation()},toggle:function(e){r.active=!r.active,e&&e.stopPropagation()}};t.on("click",function(){n(function(){r.close()})}),t.on("keyup",function(e){27===e.keyCode&&n(function(){r.close()})}),e.miUtilPreventScrollOnMenuActive=!0,e.$watch("$menu.active",function(t){e.miUtilPreventScrollOnMenuActive&&angular.element(document.body).css({overflow:t?"hidden":""})});var a=e.$modal={active:!1,open:function(e){a.active=e},close:function(){a.active=!1},toggle:function(e){a.active===e?a.close():a.open(e)},isOpen:function(e){return a.active===e}};t.on("keyup",function(e){27===e.keyCode&&n(function(){a.close()})}),e.$watch("$modal.active",function(t){angular.element(document.body).css({overflow:t?"hidden":""}),e.$broadcast("$modal."+(t?"open":"close"))})}]).filter("length",function(){return function(e){return angular.isArray(e)?e.length:angular.isObject(e)?Object.keys(e).filter(function(e){return"$"!=e[0]}).length:0}}).filter("unique",function(){return function(e,t){if(!e)return e;for(var n={},r=[],a=0;a<e.length;a++)n[angular.isFunction(t)?t(e[a]):e[a][t]]=e[a];for(var o in n)r.push(n[o]);return r}}).directive("miIcon",function(){return{scope:{svg:"@",size:"@"},restrict:"E",replace:!0,templateNamespace:"svg",template:'<svg xmlns="http://www.w3.org/2000/svg" class="mi-icon" style="display: inline-block; width: {{ size || 16 }}px; height: {{ size || 16 }}px; fill: currentColor; vertical-align: middle;"><use xlink:href="" /></svg>',link:function(e,t,n){n.$observe("svg",function(e){t.children().attr("xlink:href","assets/icons.svg#"+e)})}}}).directive("miModal",function(){return{scope:{id:"@"},restrict:"E",replace:!0,transclude:!0,template:'<aside ng-show="$root.$modal.isOpen(id)" ng-click="$root.$modal.close()" class="mi-modal-container" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0;">\n				<div class="mi-modal">\n					<div ng-click="$event.stopPropagation()" class="mi-modal-content" ng-transclude></div>\n					<a ng-click="$root.$modal.close()" class="mi-modal-close">\n						<mi-icon svg="x"></mi-icon>\n					</a>\n				</div>\n			</aside>'}}).directive("miClickToggle",["$timeout","$parse",function(e,t){return{restrict:"A",link:function(n,r,a){var o=n.$eval(a.miClickToggle);r.on("click",function(r){r.preventDefault(),e(function(){angular.forEach(o,function(e,r){return t(r).assign(n,e)})})}),angular.forEach(o,function(e,t){n.$watch(t,function(t){void 0!==t&&r[e===t?"addClass":"removeClass"](n.$eval(a.miClickToggleActive)||"active")})})}}}]),angular.module("XXXXXX",["ui.router","ui.router.title","miUtil","firebaseHelper","ngHandsontable"]).config(["$locationProvider","$urlRouterProvider","$urlMatcherFactoryProvider","$stateProvider","$firebaseHelperProvider","$provide",function(e,t,n,r,a){e.html5Mode(!0).hashPrefix("!"),t.when("","/"),t.when("/home","/"),t.when(/^\/competitions\/[^\/]+$/,"$0/settings"),n.strictMode(!1);var o=["home","competitions"];r.state("main",{"abstract":!0,templateUrl:"views/main.html"}).state("page",{parent:"main",url:"/{page:|"+o.join("|")+"}",templateUrl:function(e){return"views/page/"+(e.page||"home")+".html"},resolve:{$title:["$stateParams",function(e){switch(e.page){case"":case"home":return"";default:return e.page[0].toUpperCase()+e.page.slice(1)}}]}}).state("competition",{abtract:!0,parent:"page",url:"/:competitionId",templateUrl:"views/page/competition.html",resolve:{Sections:["$firebaseHelper",function(e){return e.array("sections")}],Competition:["$firebaseHelper","$stateParams",function(e,t){return e.object("competitions",t.competitionId)}],CompetitionData:["$firebaseHelper","$stateParams",function(e,t){return e.object("competitionsData",t.competitionId)}],$title:["Competition",function(e){return e.name}]},controller:["$scope","$firebaseHelper","Sections","Competition","CompetitionData",function(e,t,n,r,a){e.sections=n,e.competition=r,e.competitionData=a}]}).state("competition.section",{url:"/:section",templateUrl:function(e){var t="";switch(e.section){case"settings":case"groups":case"schedule":case"scores":case"results":t=e.section;break;default:t="table"}return"views/page/competition/"+t+".html"},controller:["$rootScope","$scope","$stateParams","$firebaseHelper","$filter","Sections","Competition","CompetitionData",function(e,t,n,r,a,o,i,c){var s=n.section,u=e.getAge=function(e){return e?moment(i.date).diff(e,"years"):void 0},l=(e.getGroupName=function(e){return e.level+" "+e.min+"-"+e.max},function(e){var t={};return angular.forEach(c.dancers,function(n,r){if(n.level===e.level){var a=u(n.dob);parseInt(e.min)<=a&&a<=parseInt(e.max)&&(t[n.$id||r]=n)}}),t}),f=function(e,t,n){var r=Array.from(new Array(e),function(){return[]}),a=Array.from(new Array(e),function(){return 0});t=t.sort(function(e,t){return t[n]-e[n]});var o=function(){return a.indexOf(Math.min.apply(Math,a))};return angular.forEach(t,function(e){var t=o();r[t].push(e),a[t]+=e[n]||0}),r};switch(s){case"settings":break;case"groups":t.levels=r.array(c,"levels"),t.dancers=r.array(c,"dancers"),t.byLevel=function(e){return function(t){return t.level===e.name}},t.generateGroups=function(e,t){t.data=[],r.array(c,"levels").$loaded(function(n){angular.forEach(n,function(n){n.$counter=n.$counted=n.$min=n.$max=0,angular.forEach(e,function(r,a){n.$counter+=r[n.name]||0,n.$min||(n.$min=r.age),n.$counter>=1&&n.$counted>=1||a>=e.length-1?(n.$max=r.age,t&&t.data&&t.data.push({level:n.name,min:n.$min,max:n.$max}),n.$counter=n.$counted=n.$min=n.$max=0):n.$counted++})})})};break;case"schedule":r.array(c,"dances").$loaded(function(e){t.dances=e,r.array(c,"groups").$loaded(function(n){angular.forEach(n,function(e){e.$dancersCount=Object.keys(l(e)).length}),r.array(c,"platforms").$loaded(function(r){t.platforms=r,angular.forEach(e,function(e){e.$groups=n.filter(function(t){return!!e[t.level]});var t=f(r.length,e.$groups,"$dancersCount");e.$platforms=angular.copy(r),angular.forEach(e.$platforms,function(e,n){e.$groups=t[n]})})})})});break;case"scores":case"results":t.getPlacesArray=_.memoize(function(e){for(var t=[],n=0;n<Math.ceil(a("length")(e.$dancers)/2);n++){var r=(n+1).toString(),o="th";switch(r[r.length-1]){case"1":o="st";break;case"2":o="nd";break;case"3":o="rd"}t.push(r+o)}return t}),t.scores=r.array(c,"scores"),t.scores.$loaded(function(){return t.scores.$$loaded=!0}),t.saveScore=function(e,n,a,o){r.ref(t.scores,e,n,a).set(o||null)},r.array(c,"groups").$loaded().then(function(e){return t.groups=e,r.array(c,"dances").$loaded()}).then(function(e){angular.forEach(t.groups,function(t){t.$dancers=l(t),t.$dances=e.filter(function(e){return!!e[t.level]})})});break;default:var p=t.hot=r.hot(c,s);r.load(o).then(function(e){switch(p.settings=angular.copy(angular.extend(e.settings||{},e[s]||{})),s){case"dances":r.array(c,"levels").$loaded(function(e){angular.forEach(e,function(e){p.settings.columns.push({data:e.name,title:e.name,type:"checkbox",uncheckedTemplate:""})})});break;case"dancers":p.settings.columns.push({data:"dob",title:"(Age)",type:"age",readOnly:!0})}angular.forEach(p.settings.columns,function(e){"age"===e.type?(e.type="numeric",e.renderer=function(e,t,n,r,a,o,i){var c=u(o);return Handsontable.renderers.NumericRenderer(e,t,n,r,a,c,i),t}):"level"===e.data&&r.array(c,"levels").$loaded(function(t){var n=[];angular.forEach(t,function(e){return n.push(e.name)}),e.source=n})})})}}]}).state("404",{parent:"main",templateUrl:"views/page/404.html"}),t.otherwise(function(e,t){var n=e.get("$state");return n.go("404",null,{location:!1}),t.path()}),a.namespace("scotdance")}]).controller("AppCtrl",["$rootScope","$scope","$state","$firebaseHelper","$timeout",function(e,t,n,r,a){e.$state=n,r.hot=function(){var e={ref:r.ref.apply(this,arguments),parseData:function(t){a(function(){var n=t.exportVal(),r=Object.keys(n||{}).map(function(e){var t=angular.copy(n[e]);return t.$id=e,t});e.original=angular.copy(r),e.revisions||(e.data=r,angular.isFunction(e.callback)&&e.callback(e.data)),e.revisions++})},callback:null,onData:function(t){e.callback=t},init:function(){e.ref.orderByPriority().on("value",e.parseData)},reload:function(){e.revisions=0,e.ref.orderByPriority().once("value",e.parseData)},save:function(){var t={};e.data.forEach(function(n){var r=n.$id||e.ref.push().key(),a=angular.copy(n);delete a.$id,angular.forEach(a,function(e,t){(""===e||t.match(/^[^\w\d_]/))&&delete a[t]}),t[r]=a}),e.revisions=0,e.ref.set(t,e.reload)},dirty:function(){if(e.data&&e.original){var t=e.data.filter(function(e){var t=!1;return angular.forEach(e,function(e){return t=t||e}),t});return!angular.equals(t,e.original)}},revisions:0,data:[]};return e.init(),e}}]).controller("CompetitionsCtrl",["$scope","$firebaseHelper",function(e,t){e.competitions=t.array("competitions")}]).directive("input",function(){return{restrict:"E",require:"?ngModel",link:function(e,t,n,r){switch(n.type){case"date":r.$formatters.push(function(e){return new Date(moment(e).format())}),r.$parsers.push(function(e){return moment(new Date(e)).format()});break;case"number":case"range":r.$formatters.push(function(e){return e||0}),r.$parsers.push(function(e){return parseFloat(e)||0})}}}}).filter("groupByAge",["$rootScope",function(e){return _.memoize(function(t){var n={};return angular.forEach(t,function(t){var r=e.getAge(t.dob);n[r]=n[r]||[],n[r].push(t)}),n})}]).filter("groupByGroup",function(){return _.memoize(function(e){var t=[],n=[];return angular.forEach(e,function(e){e&&(e.length>=6?(n.length&&(e=e.concat(n)),t.push(angular.copy(e))):(n=n.concat(e),n.length>=6&&(t.push(angular.copy(n)),n=[])))}),n.length&&(t.length?t[t.length-1]=t[t.length-1].concat(angular.copy(n)):t.push(angular.copy(n)),n=[]),t})});